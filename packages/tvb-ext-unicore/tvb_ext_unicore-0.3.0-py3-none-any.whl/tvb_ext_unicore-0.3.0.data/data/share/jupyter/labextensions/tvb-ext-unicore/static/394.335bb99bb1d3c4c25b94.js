"use strict";(self.webpackChunktvb_ext_unicore=self.webpackChunktvb_ext_unicore||[]).push([[394],{394:(e,t,a)=>{a.r(t),a.d(t,{default:()=>A});var s=a(503),n=a(169),r=a(576),i=a(165),o=a(271),l=a.n(o),c=a(694),d=a(526),u=a(19),g=a(579);async function m(e="",t={}){const a=g.ServerConnection.makeSettings(),s=u.URLExt.join(a.baseUrl,"tvbextunicore",e);let n;console.log("req URL: ",s);try{n=await g.ServerConnection.makeRequest(s,t,a)}catch(e){throw new g.ServerConnection.NetworkError(e)}let r=await n.text();if(r.length>0)try{r=JSON.parse(r)}catch(e){console.log("Not a JSON response body.",n)}if(!n.ok)throw new g.ServerConnection.ResponseError(n,r.message||r);return r}const h="NONE",b="text/plain";function p(e){return`from tvbextunicore.unicore_wrapper import unicore_wrapper\nunicore = unicore_wrapper.UnicoreWrapper()\njob = unicore.get_job('${e}')\njob`}var S=a(918);const E=e=>{const[t,a]=(0,o.useState)(null),[s,n]=(0,o.useState)("");return(0,o.useEffect)((()=>{m(`job_output?job_url=${encodeURIComponent(e.job_url)}`).then((e=>a(e))).catch((e=>{console.log("err: ",e),n(e.message)}))}),[]),l().createElement("tr",{className:"outputFiles","data-testid":`output-${e.job_url}`},t?l().createElement("td",{colSpan:100},l().createElement("p",{className:"unicoreMessage"},s),"Output Files:",Object.entries(t).map((([t,a],s)=>l().createElement(w,{output:t,outputType:a,key:`${t}-${s}`,jobUrl:e.job_url,jobId:e.jobId,getFileBrowser:e.getFileBrowser,getKernel:e.getKernel})))):l().createElement("td",{colSpan:100},s?l().createElement("p",{className:"unicoreMessage"},s):l().createElement("div",{className:"loadingRoot"},l().createElement("span",{className:"unicoreLoading"}))))},w=e=>{const{output:t,outputType:a,jobUrl:s,getFileBrowser:r,jobId:i}=e,[u,g]=(0,o.useState)(!1),h={success:"unicoreMessage-success",warning:"unicoreMessage-warning",error:"unicoreMessage"},[p,E]=(0,o.useState)({text:"",className:h.success});let w;async function f(e){let t=e;if(["stdout","stderr","UNICORE_SCRIPT_EXIT_CODE"].includes(t)&&(t=`${e}_${i}`),function(e){const t=r().model.items();return(0,S.some)(t,((t,a)=>t.name===e))}(t)&&!await async function(e){return(await(0,n.showDialog)({title:"File already exists!",body:`If you continue the file ${e}} will be re downloaded and overwritten!`,buttons:[n.Dialog.cancelButton({label:"Cancel"}),n.Dialog.okButton({label:"Continue"})]})).button.accept}(t))return;const a=r(),o=a.model.path;console.log("File browser path: ",o);const l={job_url:s,in_file:e,path:o,out_file:t};try{g(!0);const t=await m(`drive/${encodeURIComponent(s)}/${e}`,{method:"POST",body:JSON.stringify(l)});console.log("response: ",t),E({text:t.message,className:h[t.status]}),g(!1),a.update()}catch(e){await(0,n.showErrorMessage)("Error on request:",e),E({text:e.text,className:h.error}),g(!1)}}async function v(e){await f(t),j()}function j(){r().node.removeEventListener("drop",v),null==w||w.dispose()}return l().createElement("div",{className:"unicore-jobOutput","data-testid":`output-${t}`},a.is_file?l().createElement("i",{className:"fa fa-file"}):l().createElement("i",{className:"fas fa-folder"}),l().createElement("p",{draggable:!0,className:"outputFileName",onDragStart:async function(e){r().node.addEventListener("drop",v);const a=`from tvbextunicore.unicore_wrapper import unicore_wrapper\nunicore = unicore_wrapper.UnicoreWrapper()\ndownload_result = unicore.download_file('${s}', '${t}')\ndownload_result`;w=new c.Drag({mimeData:new d.MimeData,supportedActions:"copy",proposedAction:"copy",source:t}),w.mimeData.setData(b,a),w.start(e.clientX,e.clientY).then((e=>{console.log("r: ",e),j()}))}},t),a.is_file&&l().createElement(l().Fragment,null,l().createElement("span",{className:p.className},p.text),u?l().createElement("div",{className:"loadingRoot"},l().createElement("span",{className:"unicoreLoading"})):l().createElement("i",{"data-testid":"download-file",className:"fa fa-download clickableIcon",onClick:()=>f(t)})))},f=e=>l().createElement("table",null,l().createElement(v,{columns:e.columns}),l().createElement(j,{buttonSettings:e.buttonSettings,columns:e.columns,data:e.data,setMessageState:e.setMessageState,getKernel:e.getKernel,getJob:e.getJob,handleError:e.handleError,getFileBrowser:e.getFileBrowser})),v=e=>l().createElement("thead",null,l().createElement("tr",null,e.columns.map((e=>l().createElement("td",{key:e,className:e},e.toUpperCase()))),l().createElement("td",null,"ACTIONS"))),j=e=>l().createElement("tbody",null,e.data.map((t=>l().createElement(y,{key:t.id,id:t.id,cols:e.columns,job:t,buttonSettings:e.buttonSettings,setMessageState:e.setMessageState,getKernel:e.getKernel,getJob:e.getJob,handleError:e.handleError,getFileBrowser:e.getFileBrowser})))),y=e=>{const[t,a]=(0,o.useState)(e.job),[s,n]=(0,o.useState)(!1),[r,i]=(0,o.useState)(!1);return l().createElement(l().Fragment,null,l().createElement("tr",{onClick:()=>i(!r),draggable:"true",onDragStart:async function(a){var s;if(!await e.getKernel())return void e.handleError("Current kernel can't be used to handle this operation!");const n=e.getJob(t.resource_url),r=new c.Drag({mimeData:new d.MimeData,supportedActions:"copy",proposedAction:"copy",dragImage:null===(s=document.getElementById(`${t.id}`))||void 0===s?void 0:s.cloneNode(!0),source:t});r.mimeData.setData(b,n),r.start(a.clientX,a.clientY).then((e=>console.log("r: ",e)))},"data-testid":`table-row-${e.job.id}`},e.cols.map(((e,a)=>l().createElement("td",{key:`${t.id}-${a}`},t[e]))),s?l().createElement("td",null,l().createElement("div",{className:"loadingRoot"},l().createElement("span",{className:"unicoreLoading"}))):l().createElement("td",null,t.is_cancelable&&!s&&l().createElement("button",{onClick:function(s){s.stopPropagation(),n(!0),e.buttonSettings.onClick(...e.buttonSettings.onClickFieldArgs.map((e=>t[e]))).then((t=>{n(!1),a(t.job),e.setMessageState(t.message)}))}},"Cancel Job"))),r&&l().createElement(l().Fragment,null,l().createElement(E,{job_url:t.resource_url,getFileBrowser:e.getFileBrowser,getKernel:e.getKernel,jobId:t.id}),l().createElement("tr",{className:"detailsRow"},l().createElement("td",{colSpan:100},l().createElement("textarea",{value:t.logs.join("\n"),readOnly:!0})))))},C=e=>l().createElement("div",{className:"unicorePagination","data-testid":"pagination-component"},l().createElement("div",null,l().createElement("div",{className:"btnLeftContainer"},e.showPrevButton&&l().createElement("button",{onClick:function(){e.setPageState(e.currentPage-1)},"data-testid":"p-btn-left"},l().createElement("i",{className:"fa fa-arrow-left"}))),l().createElement("div",{className:"currentPageContainer"},l().createElement("span",null,`Page: ${e.currentPage}`)),l().createElement("div",{className:"btnRightContainer"},e.showNextButton&&l().createElement("button",{onClick:function(){e.setPageState(e.currentPage+1)},"data-testid":"p-btn-right"},l().createElement("i",{className:"fa fa-arrow-right"})))));function N({onToggle:e,initialCheckedState:t,label:a}){const[s,n]=(0,o.useState)(t);return l().createElement("div",null,l().createElement("input",{id:"auto-refresh",type:"checkbox",checked:s,onChange:t=>{n(t.target.checked),e(t.target.checked)}}),a&&l().createElement("label",{htmlFor:"auto-refresh"},a))}const O=e=>{const[t,a]=(0,o.useState)(!1);return l().createElement("div",{className:"pyunicoreSites","data-testid":"pyunicore-sites"},l().createElement("div",null,l().createElement("span",null,"SITE:"),l().createElement("select",{onChange:function(t){e.onChangeSite(t.target.value)},disabled:e.disableSelection,"data-testid":"select"},e.sites.map((e=>l().createElement("option",{key:e,id:e,value:e},e))))),l().createElement("button",{className:`refreshBtn ${t&&"spin"}`,onClick:()=>{a(!0),setTimeout((()=>a(!1)),500),e.refreshSite()},disabled:e.loading},l().createElement("i",{className:"fa fa-refresh"})),l().createElement(N,{onToggle:e.setAutoReload,initialCheckedState:!0,label:"Auto refresh"}))};var k;!function(e){e.Warning="WARNING",e.Error="ERROR",e.Success="SUCCESS",e.Confirm="CONFIRM"}(k||(k={}));const R=e=>l().createElement("div",{className:"unicoreModal",style:{display:e.visible?"flex":"none"},"data-testid":"modal-widget"},l().createElement("div",null,l().createElement("div",null,l().createElement("h3",null,e.modalType)),l().createElement("div",null,l().createElement("p",null,String(e.message))),l().createElement("div",null,l().createElement("button",{onClick:()=>e.setVisible(!1)},"CLOSE"))));class _ extends n.ReactWidget{constructor(e){super(),this.addClass("tvb-pyunicoreWidget"),this.props=e}render(){return l().createElement(F,{tableFormat:this.props.tableFormat,data:this.props.data,buttonSettings:this.props.buttonSettings,sites:this.props.sites,reloadRate:6e4,getKernel:this.props.getKernel,getJobCode:this.props.getJobCode,getFileBrowser:this.props.getFileBrowser})}}class F extends l().Component{constructor(e){super(e),this._triggerUpdate=(e=!1)=>{this.state.site!==h&&(e||this.state.autoReload&&(new Date).valueOf()-this.state.lastUpdate.valueOf()>=this.state.reloadRate&&!this.state.loading)&&this.getData().catch(this.catchError)},this.setPageState=this.setPageState.bind(this),this.setSiteState=this.setSiteState.bind(this),this.setModalSateVisible=this.setModalSateVisible.bind(this),this.getData=this.getData.bind(this),this.catchError=this.catchError.bind(this),this.setAutoReload=this.setAutoReload.bind(this);const t=new Date;this.state={jobs:[],message:e.data.message,site:e.sites[0],buttonSettings:e.buttonSettings,tableFormat:e.tableFormat,reloadRate:6e4,loading:e.sites.length>0,sites:e.sites,page:1,itemsPerPage:10,lastUpdate:t,renderLeftArrow:!1,renderRightArrow:!1,disableSitesSelection:!0,modalState:{modalType:k.Error,message:"",visible:!1,setVisible:this.setModalSateVisible},autoReload:!0,updateIntervalId:0}}_getEndpoint(){return`jobs?site=${this.state.site}&page=${this.state.page}`}async getData(){this.setState(Object.assign(Object.assign({},this.state),{loading:!0,renderLeftArrow:!1,renderRightArrow:!1,disableSitesSelection:!0}));const e=await m(this._getEndpoint());return this.setState(Object.assign(Object.assign({},this.state),{jobs:e.jobs,message:e.message,loading:!1,lastUpdate:new Date,renderLeftArrow:this.state.page>1,renderRightArrow:e.jobs.length>=this.state.itemsPerPage,disableSitesSelection:!1})),e}setPageState(e){this.setState(Object.assign(Object.assign({},this.state),{page:e}))}setModalSateVisible(e){this.setState(Object.assign(Object.assign({},this.state),{loading:!1,renderLeftArrow:!0,renderRightArrow:!0,disableSitesSelection:!1,modalState:Object.assign(Object.assign({},this.state.modalState),{visible:e})}))}setSiteState(e){let t=this.state.jobs;e===h&&(t=[]),this.setState(Object.assign(Object.assign({},this.state),{page:1,site:e,jobs:t}))}setAutoReload(e){this.setState(Object.assign(Object.assign({},this.state),{autoReload:e}))}componentDidUpdate(e,t){if((t.page!==this.state.page||t.site!==this.state.site)&&this.state.sites.length>0){if(this.state.site===h)return void this.setState(Object.assign(Object.assign({},this.state),{loading:!1,disableSitesSelection:!1,jobs:[],renderLeftArrow:!1,renderRightArrow:!1}));this.getData().catch(this.catchError)}}catchError(e){this.setState(Object.assign(Object.assign({},this.state),{modalState:Object.assign(Object.assign({},this.state.modalState),{visible:!0,message:e})}))}componentWillUnmount(){clearInterval(this.state.updateIntervalId)}componentDidMount(){const e=setInterval(this._triggerUpdate,1e4);this.setState(Object.assign(Object.assign({},this.state),{updateIntervalId:e})),this.state.site!==h?this.state.sites.length<=0||this.getData().catch(this.catchError):this.setState(Object.assign(Object.assign({},this.state),{loading:!1,disableSitesSelection:!1}))}render(){return l().createElement(l().Fragment,null,l().createElement(R,{modalType:this.state.modalState.modalType,message:this.state.modalState.message,visible:this.state.modalState.visible,setVisible:this.state.modalState.setVisible}),l().createElement("div",{className:"unicoreTopBar"},l().createElement(C,{setPageState:this.setPageState,showNextButton:this.state.renderRightArrow,showPrevButton:this.state.renderLeftArrow,currentPage:this.state.page}),l().createElement(O,{sites:this.state.sites,onChangeSite:this.setSiteState,disableSelection:this.state.disableSitesSelection,refreshSite:()=>this._triggerUpdate(!0),loading:this.state.loading,setAutoReload:this.setAutoReload}),this.state.loading?l().createElement("div",null,l().createElement("div",{className:"loadingRoot"},l().createElement("span",{className:"unicoreLoading"}))):l().createElement("div",null,l().createElement("span",{className:"unicoreMessage"},this.state.message),l().createElement("span",{className:"lastUpdate"},"Last update: ",this.state.lastUpdate.toLocaleTimeString()))),l().createElement(f,{buttonSettings:this.state.buttonSettings,columns:this.state.tableFormat.cols,data:this.state.jobs,setMessageState:e=>{this.setState(Object.assign(Object.assign({},this.state),{message:e}))},getKernel:this.props.getKernel,getJob:this.props.getJobCode,handleError:this.catchError,getFileBrowser:this.props.getFileBrowser}))}}var I=a(433);async function x(e){const t={resource_url:e};return m("jobs",{method:"POST",body:JSON.stringify(t)})}const A={id:"tvbextunicore:plugin",autoStart:!0,requires:[n.ICommandPalette,s.ILayoutRestorer,I.IConsoleTracker,s.ILabShell,i.INotebookTracker,r.IFileBrowserFactory],activate:async(e,t,a,s,r,i,o)=>{let l;console.log("JupyterLab extension tvb-ext-unicore is activated!");const c=["id","name","owner","site","status","start_time"],d="tvbextunicore:open";e.commands.addCommand(d,{label:"PyUnicore Task Stream",execute:async()=>{if(!l||l.isDisposed){const e=await m("sites"),t=new _({tableFormat:{cols:c,idField:"id",buttonRenderConditionField:"is_cancelable"},data:{message:e.message,jobs:[]},buttonSettings:{onClick:x,onClickFieldArgs:["resource_url"],isAsync:!1,name:"Cancel Job"},sites:[h,...Object.keys(e.sites)],reloadRate:6e4,getKernel:async()=>{const e=B.getCurrentKernel(r,i,s);return await B.shouldUseKernel(e)?e:null},getJobCode:p,getFileBrowser:()=>B.getFileBrowser(o)});l=new n.MainAreaWidget({content:t}),l.id="tvbextunicore",l.title.label="PyUnicore Task Stream",l.title.closable=!0}u.has(l)||u.add(l),l.isAttached||e.shell.add(l,"main"),e.shell.activateById(l.id)}}),t.addItem({command:d,category:"PyUnicore"});const u=new n.WidgetTracker({namespace:"pyunicore"});a.restore(u,{command:d,name:()=>"pyunicore"})}};var B;!function(e){e.shouldUseKernel=async function(e){if(!e)return!1;const t=await e.spec;return!!t&&-1!==t.language.toLowerCase().indexOf("python")},e.getCurrentKernel=function(e,t,a){var s,n,r,i;let o,l=e.currentWidget;return l&&t.has(l)?o=null===(s=l.sessionContext.session)||void 0===s?void 0:s.kernel:l&&a.has(l)?o=null===(n=l.sessionContext.session)||void 0===n?void 0:n.kernel:t.currentWidget?(l=t.currentWidget,o=null===(r=l.sessionContext.session)||void 0===r?void 0:r.kernel):a.currentWidget&&(l=a.currentWidget,o=null===(i=l.sessionContext.session)||void 0===i?void 0:i.kernel),o},e.getFileBrowser=function(e){return e.defaultBrowser}}(B||(B={}))}}]);