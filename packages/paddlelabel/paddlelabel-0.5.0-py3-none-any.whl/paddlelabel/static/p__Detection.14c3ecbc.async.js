(self.webpackChunkPaddleLabel_Frontend=self.webpackChunkPaddleLabel_Frontend||[]).push([[18],{72285:function(fn){fn.exports={det:"det___3GOn8",mainStage:"mainStage___36l4G",draw:"draw___1EIyT",pblock:"pblock___107zJ",progress:"progress___vIcpV",rightSideBar:"rightSideBar___3n2bi",determinOutline:"determinOutline___1p2xS"}},58857:function(fn,ln,u){"use strict";u.r(ln),u.d(ln,{default:function(){return oe}});var B=u(11849),Cn=u(20228),En=u(11382),q=u(86582),On=u(34792),Q=u(48086),U=u(91220),w=u(2824),a=u(67294),_=u(51505),Zn=u(48971),Rn=u(72285),jn=u.n(Rn),Bn=u(8088),L=u(61541),Mn=u(44434),Fn=u(5041),Xn=u(57436),Nn=u(84420),Yn=u.n(Nn),zn=u(28271),$n=u(14836),Pn=u(83721),gn=u(65031),Dn=u(57406);function Hn(o){if(!(!o||o.length<2))return o.join(",")}var mn={x:0,y:0},hn={x:0,y:0},nn=!1;function Gn(o,g,y){y.save(),y.strokeStyle="rgba(0,0,230,0.9)",y.lineWidth=.8,Wn(o,y),Vn(g,y),y.restore()}function Vn(o,g){console.log("context.canvas.width",g.canvas.width),g.beginPath(),g.moveTo(0,o+.5),g.lineTo(g.canvas.width,o+.5),g.stroke()}function Wn(o,g){g.beginPath(),g.moveTo(o+.5,0),g.lineTo(o+.5,g.canvas.height),g.stroke()}function Jn(o){var g,y,F,H;console.log("drawRectangle, annotation:",o.annotation);var G=o==null||(g=o.annotation)===null||g===void 0||(y=g.result)===null||y===void 0?void 0:y.split(",").length;if(G&&G<4)return a.createElement(a.Fragment,null);var f=o.annotation;if(!f||!f.result||!f.label||!f.label.color||!f.annotationId)return a.createElement(a.Fragment,null);var l=f.result.split(",");console.log("pointsRaw",l);var d={xmin:parseInt(l[0]),ymin:parseInt(l[1]),xmax:l.length>=3?parseInt(l[2]):void 0,ymax:l.length>=4?parseInt(l[3]):void 0},h=f.label.color,D=(0,Dn.oo)(h);if(!D)return a.createElement(a.Fragment,null);console.log("props.currentAnnotatio:",(F=o.currentAnnotation)===null||F===void 0?void 0:F.frontendId,f==null?void 0:f.frontendId);var V=((H=o.currentAnnotation)===null||H===void 0?void 0:H.frontendId)==f.frontendId,yn=V?.5:.1,cn=d.xmax!=null&&d.ymax!=null?a.createElement(gn.UL,{onMouseOver:function(){o.currentTool=="editor"&&(document.body.style.cursor="pointer")},onMouseOut:function(){document.body.style.cursor="default"},onClick:function(){console.log("props.currentTool",o.currentTool,f),o.currentTool!=="rectangle"&&o.onSelect(f)},stroke:h,strokeWidth:2/o.scale,globalCompositeOperation:"source-over",lineCap:"round",x:d.xmin,y:d.ymin,width:d.xmax-d.xmin,height:d.ymax-d.ymin,closed:!0,fill:"rgba(".concat(D.r,", ").concat(D.g,", ").concat(D.b,", ").concat(yn,")")}):a.createElement(a.Fragment,null);function W(O){if(!O&&(d.xmax==null||d.ymax==null))return a.createElement(a.Fragment,null);var un=function(p){var en;if(o.currentTool=="editor"){var dn=(en=o.stageRef)===null||en===void 0?void 0:en.current,b=dn.findOne(".baseImage"),J=!1,X=p.target.x();X>b.width()/2&&(X=b.width()/2,J=!0),X<-b.width()/2&&(X=-b.width()/2,J=!0);var R=p.target.y();R>b.height()/2&&(R=b.height()/2,J=!0),R<-b.height()/2&&(R=-b.height()/2,J=!0),J&&p.target.setPosition({x:X,y:R}),O?(d.xmin=X,d.ymin=R):(d.xmax=X,d.ymax=R);var Y=(0,B.Z)((0,B.Z)({},f),{},{predicted_by:null,result:"".concat(d.xmin,",").concat(d.ymin,",").concat(d.xmax,",").concat(d.ymax)});o.onDragUP(Y)}};return a.createElement(gn.Cd,{onMouseDown:function(){o.currentTool=="editor"&&(o.OnSelects(f),o.onSelect(f))},draggable:o.currentTool=="editor",onDragEnd:un,onMouseOver:function(){var p;o.currentTool=="editor"&&(p=o.stageRef)!==null&&p!==void 0&&p.current&&(o.stageRef.current.container().style.cursor="cell")},onMouseOut:function(){var p;(p=o.stageRef)!==null&&p!==void 0&&p.current&&(o.stageRef.current.container().style.cursor="default")},x:O?d.xmin:d.xmax,y:O?d.ymin:d.ymax,radius:5/o.scale,fill:h})}return a.createElement(gn.ZA,{key:f.annotationId},cn,W(!0),W(!1))}function Kn(o){var g=function(l,d){var h,D=Hn([l,d]);!D||!o.dataId||(console.log("props.annotations:",o.annotations),o.onAnnotationAdd({dataId:o.dataId,type:"rectangle",frontendId:(0,Dn.pL)(o.annotations)+1,label:o.currentLabel,labelId:(h=o.currentLabel)===null||h===void 0?void 0:h.labelId,result:D}))},y=function(l,d){var h;if(!(!o.currentAnnotation||!o.currentAnnotation.result||!((h=o.currentLabel)!==null&&h!==void 0&&h.color))){var D=o.currentAnnotation.result+",".concat(l,",").concat(d),V=(0,B.Z)((0,B.Z)({},o.currentAnnotation),{},{result:D});console.log("addDotToRectangle",V),o.modifyAnnoByFrontendId(V)}},F=function(l){if(o.currentTool=="rectangle"){nn=!0;var d=l.mouseX+l.offsetX,h=l.mouseY+l.offsetY;console.log("mouseX:",mn,hn),mn.x=l.mouseX,mn.y=l.mouseY,console.log("props.currentAnnotation",l.mouseX,l.mouseX,l.offsetX,l.offsetY),g(d,h),o.onMouseDown&&o.onMouseDown()}},H=function(l){o.currentTool!="rectangle"&&nn!==!0||(hn.x=l.mouseX,hn.y=l.mouseY,nn&&console.log("renderReact\u51FD\u6570\u6267\u884C\u4E86"))},G=function(l){if(!(o.currentTool!="rectangle"&&o.currentTool!="editor"&&nn)){nn=!1,console.log("OnMouseUp");var d=l.mouseX+l.offsetX,h=l.mouseY+l.offsetY;y(d,h),o.onMouseUp&&o.onMouseUp()}};return{onMouseDown:F,onMouseMove:H,onMouseUp:G,drawAnnotation:Jn,drawGuidewires:Gn}}var Qn=u(10137),qn=u(36505),_n=u(27992),ne=window.location.port=="8000"?"1234":window.location.port,ee="http://".concat(window.location.hostname,":").concat(ne,"/"),te=function(){var g,y,F,H=(0,a.useState)(0),G=(0,w.Z)(H,2),f=G[0],l=G[1],d=(0,a.useState)(!0),h=(0,w.Z)(d,2),D=h[0],V=h[1],yn=(0,a.useState)(!0),cn=(0,w.Z)(yn,2),W=cn[0],O=cn[1],un=(0,Zn.tT)("InteractorData"),S=un.interactorData,p=un.setInteractorData,en=(0,a.useState)(50),dn=(0,w.Z)(en,2),b=dn[0],J=dn[1],X=(0,a.useState)(!1),R=(0,w.Z)(X,2),Y=R[0],pn=R[1],ae=(0,a.useState)(),bn=(0,w.Z)(ae,2),m=bn[0],re=bn[1],ie=(0,a.useState)(!1),Tn=(0,w.Z)(ie,2),xn=Tn[0],tn=Tn[1],le=(0,a.useState)(),wn=(0,w.Z)(le,2),ce=wn[0],ue=wn[1],z=(0,Pn.RZ)(a.useState,ee),K=(0,a.useRef)(null),A=(0,qn.I)("pages.toolBar"),N=(0,Pn.$L)(a.useState,a.useEffect,{effectTrigger:{postTaskChange:function(n,t){an.init({annos:t})}},label:{oneHot:!0,postSelect:function(){e.setCurr(void 0),l(0)},preUnsetCurr:fe},tool:{defaultTool:"mover"},task:{push:!1}}),k=N.tool,de=N.loading,on=N.scale,e=N.annotation,sn=N.task,P=N.data,M=N.project,C=N.label,an=N.annHistory,se=Yn()(P.imgSrc||"","anonymous"),ve=(0,w.Z)(se,1),vn=ve[0];function fe(){e.setCurr(void 0),l(0),console.log("preCurrLabelUnset"),k.setCurr("mover")}var E=function(n){console.log("setCurrentAnnotation"),e.setCurr(n),n!=null&&n.frontendId?l(n.frontendId):l(0)},In=function(n){var t=[],i=(0,U.Z)(e.all),c;try{for(i.s();!(c=i.n()).done;){var v=c.value;if(console.log("annotationfrontendId:",v.frontendId,n.frontendId,e.all),v.frontendId==n.frontendId){var s,I=n==null||(s=n.result)===null||s===void 0?void 0:s.split(",").map(function(x){return Number(x)}),T=(I[2]-I[0])*(I[3]-I[1]);Math.abs(T)>10&&(t.push(n),E(n))}else t.push(v)}}catch(x){i.e(x)}finally{i.f()}console.log("onAnnotationModify:",t,n),e.setAll(t)},ge=function(n){var t=[],i=(0,U.Z)(e.all),c;try{for(i.s();!(c=i.n()).done;){var v=c.value;console.log("annotationUP:",v,n),v.frontendId==n.frontendId?t.push(n):t.push(v)}}catch(s){i.e(s)}finally{i.f()}E(n),console.log("onAnnotationModifyUP:"),e.setAll(t),e.update(n)},me=function(){V(!0)},he=function(){V(!1)},ye=function(){var n,t,i,c;if(an.record({annos:e.all,currAnno:e.curr}),!!e.curr&&(console.log("annotations.curr",ce,e.curr,e==null||(n=e.curr)===null||n===void 0?void 0:n.annotationId,e.curr.result.split(",").length),!!e.curr.result)){var v=e.all.length-1,s=e.all[v];if(s&&(s==null||(t=s.result)===null||t===void 0?void 0:t.split(",").length)===2){var I,T=s==null?void 0:s.result.split(",").concat(e==null||(I=e.curr)===null||I===void 0?void 0:I.result.split(","));e.curr.result=T.join(",")}(e==null||(i=e.curr)===null||i===void 0?void 0:i.result.split(",").length)<3||((e==null||(c=e.curr)===null||c===void 0?void 0:c.annotationId)==null?(console.log("finish",P.curr,e.curr),e.create(e==null?void 0:e.curr)):e.update(e==null?void 0:e.curr),Q.default.success(A("saveSuccess")),k.curr=="rectangle"&&E(void 0))}},pe={dataId:(g=P.curr)===null||g===void 0?void 0:g.dataId,currentLabel:C.curr,scale:on.curr,currentTool:k.curr,annotations:e.all,currentAnnotation:e.curr,onAnnotationAdd:function(n){var t=e.all.concat([n]);e.setAll(t),E(n)},onAnnotationModify:In,modifyAnnoByFrontendId:In,onMouseUp:he,onMouseDown:me,frontendIdOps:{frontendId:f,setFrontendId:l}},Ie=Kn(pe),Se={polygon:Ie,brush:void 0},Ae=function(n){var t=e.all,i=n.annotationId,c=t.find(function(s){return s.annotationId===i});if(c){var v=t.indexOf(c);t.splice(v,1),t.push(c),e.setAll(t)}},Ce=function(n){if(!n||n.length==0)return 0;var t=0,i=(0,U.Z)(n),c;try{for(i.s();!(c=i.n()).done;){var v=c.value;v.frontendId>t&&(t=v.frontendId)}}catch(s){i.e(s)}finally{i.f()}return t},Ee=function(n){if(console.log("getBase64Image",n),!n)return"";var t=document.createElement("canvas");t.width=n.width,t.height=n.height,console.log("img.width",n.width);var i=t.getContext("2d");i==null||i.drawImage(n,0,0,n.width,n.height);var c=t.toDataURL("image/png");return console.log("dataURL",c),c.replace(/^data:image\/(png|jpg);base64,/,"")},Ln=function(n){var t=Ee(n),i=b?b*.01:.5,c=z.predict("PicoDet",{format:"b64",img:t});!c||c.then(function(v){if(v){var s,I=v.predictions.map(function(T){if(T.score>i)return T});pn(!1),P.updatePredicted((s=P.all[0])===null||s===void 0?void 0:s.dataId,!0),p({active:!0,mousePoints:S.mousePoints,predictData:I})}},function(v){z.setLoading(!1),console.log("line.error",v)})},Ze=function(n){var t=(0,q.Z)(n).map(function(i){var c={name:i,projectId:M.curr.projectId};return c});t.length>0&&C.create(t).then(function(i){E(void 0),C.setCurr(i),tn(!0)})};return(0,_.Z)(function(){if(P.all.length>0)if(P.all[0].predicted){var r=!1;r!==Y&&pn(r)}else{var n=!0;n!==Y&&pn(n)}},[P.all]),(0,a.useEffect)(function(){D||ye()},[D]),(0,_.Z)(function(){var r,n;if(Y&&(r=M.curr)!==null&&r!==void 0&&(n=r.otherSettings)!==null&&n!==void 0&&n.labelMapping){var t;if(z.loading){Q.default.error(A("modelLoading"));return}var i=(t=M.curr)!==null&&t!==void 0&&t.otherSettings?M.curr.otherSettings:{};z.setMlBackendUrl(i.mlBackendUrl||""),z.setLoading(!0),z.load(i.modelName).then(function(){z.setLoading(!1),W&&O(!1)},function(){z.setLoading(!1),W||O(!0)})}else{var c;re((c=M.curr)===null||c===void 0?void 0:c.otherSettings)}},[Y,(y=M.curr)===null||y===void 0?void 0:y.otherSettings]),(0,_.Z)(function(){var r=!W&&vn&&Y;r&&Ln(vn)},[W,Y,vn]),(0,_.Z)(function(){if(S.predictData.length&&m!==null&&m!==void 0&&m.labelMapping&&C.all){var r;console.log("interactorData.predictData",m,S.predictData.length);var n=new Set,t=new Map,i=(0,U.Z)(C.all),c;try{for(i.s();!(c=i.n()).done;){var v=c.value;v.name&&t.set(v.name,v)}}catch($){i.e($)}finally{i.f()}if((m==null||(r=m.labelMapping)===null||r===void 0?void 0:r.length)>0){var s=(0,U.Z)(m==null?void 0:m.labelMapping),I;try{for(s.s();!(I=s.n()).done;){var T=I.value;t.has(T.project)||n.add(T.project)}}catch($){s.e($)}finally{s.f()}}else{var x=(0,U.Z)(S.predictData),rn;try{for(x.s();!(rn=x.n()).done;){var Z=rn.value;console.log("!oldLabel.has(labelItem?.label_name)",t,Z==null?void 0:Z.label_name),Z&&!t.has(Z==null?void 0:Z.label_name)&&n.add(Z==null?void 0:Z.label_name)}}catch($){x.e($)}finally{x.f()}(0,q.Z)(n).length&&Ze(n)}(0,q.Z)(n).length||tn(!0)}},[S,m]),(0,_.Z)(function(){var r;if(S.predictData.length&&((r=M.curr)===null||r===void 0?void 0:r.projectId)!==void 0&&m!==null&&m!==void 0&&m.labelMapping&&xn){var n=new Map;C.getAll(M.curr.projectId).then(function(t){var i,c,v=(0,U.Z)(t),s;try{for(v.s();!(s=v.n()).done;){var I=s.value;n.set(I.name,I)}}catch(j){v.e(j)}finally{v.f()}var T=[],x=new Map,rn=(i=e.all)!==null&&i!==void 0&&i.length?Ce(e.all)+1:1;if((m==null||(c=m.labelMapping)===null||c===void 0?void 0:c.length)>0){var Z=(0,U.Z)(m.labelMapping),$;try{for(Z.s();!($=Z.n()).done;){var kn=$.value;x.set(kn.model,kn.project)}}catch(j){Z.e(j)}finally{Z.f()}}console.log("interactorData.predictData",S.predictData),S.predictData.map(function(j){if(console.log("label_name",j),j){var Sn="";x.has(j.label_name)?Sn=x.get(j.label_name):Sn=j.label_name;var Pe=n.get(Sn),De=j.result,be=m.modelName;if(S.active){var An,Un=(0,zn.tx)(rn,De,(An=P.curr)===null||An===void 0?void 0:An.dataId,Pe,be);Un&&(T.push(Un),rn++)}}});var Me=!0;e.create(T,"",Me),p({active:!1,predictData:[],mousePoints:[]}),tn(!1)})}},[M==null||(F=M.curr)===null||F===void 0?void 0:F.projectId,S.predictData,m,xn]),console.log("annitonsss",e.all),a.createElement(Bn.Z,{className:jn().det},a.createElement(Mn.Z,null,a.createElement(L.Z,{imgSrc:"./pics/buttons/rectangle.png",active:k.curr=="rectangle",onClick:function(){if(console.log("label.curr",C.curr),!C.curr){Q.default.error(A("chooseCategoryFirst"));return}k.setCurr("rectangle"),E(void 0)}},A("rectangle")),a.createElement(L.Z,{active:k.curr=="editor",imgSrc:"./pics/buttons/edit.png",onClick:function(){k.setCurr("editor")}},A("edit")),a.createElement(L.Z,{imgSrc:"./pics/buttons/zoom_in.png",onClick:function(){on.change(.1)}},A("zoomIn")),a.createElement(L.Z,{imgSrc:"./pics/buttons/zoom_out.png",onClick:function(){on.change(-.1)}},A("zoomOut")),a.createElement(L.Z,{imgSrc:"./pics/buttons/save.png",onClick:function(){var n;e.pushToBackend((n=P.curr)===null||n===void 0?void 0:n.dataId)}},A("save")),a.createElement(L.Z,{imgSrc:"./pics/buttons/move.png",active:k.curr=="mover",onClick:function(){k.setCurr("mover")}},A("move")),a.createElement(L.Z,{imgSrc:"./pics/buttons/prev.png",onClick:function(){an.backward().then(function(n){if(n){var t;e.setAll(n.annos),E(n.currAnno),e.pushToBackend((t=P.curr)===null||t===void 0?void 0:t.dataId,n.annos)}})}},A("unDo")),a.createElement(L.Z,{imgSrc:"./pics/buttons/next.png",onClick:function(){an.forward().then(function(n){if(n){var t;e.pushToBackend((t=P.curr)===null||t===void 0?void 0:t.dataId,n.annos),E(n.currAnno)}})}},A("reDo")),a.createElement(L.Z,{imgSrc:"./pics/buttons/clear_mark.png",onClick:function(){e.clear(),an.record({annos:[]}),k.setCurr(void 0),C.setCurr(void 0)}},A("clearMark"))),a.createElement("div",{id:"dr",className:"mainStage"},a.createElement(En.Z,{tip:"loading",spinning:!!de.curr},a.createElement("div",{className:"draw"},a.createElement(Xn.Z,{ref:K,taskIndex:sn.currIdx,scale:on.curr,scaleChange:on.setScale,annotations:e.all,currentTool:k.curr,currentAnnotation:e.curr,setCurrentAnnotation:E,onAnnotationModify:In,onAnnotationModifyComplete:function(){},frontendIdOps:{frontendId:f,setFrontendId:l},imgSrc:P.imgSrc,transparency:100,onAnnotationAdd:function(n){var t=e.all.concat([n]);e.setAll(t)},drawTool:Se,threshold:0,OnSelect:ue,onAnnotationModifyUP:ge})),a.createElement("div",{className:"pblock"},a.createElement(Qn.Z,{task:sn,project:M})),a.createElement("div",{className:"prevTask","data-test-id":"prevTask",onClick:function(){var n;!sn.prevTask()||(p({active:!1,predictData:[],mousePoints:[]}),E(void 0),tn(!1),K==null||(n=K.current)===null||n===void 0||n.setDragEndPos({x:0,y:0}))}}),a.createElement("div",{className:"nextTask","data-test-id":"nextTask",onClick:function(){var n;!sn.nextTask()||(p({active:!1,predictData:[],mousePoints:[]}),E(void 0),tn(!1),K==null||(n=K.current)===null||n===void 0||n.setDragEndPos({x:0,y:0}))}}))),a.createElement(Mn.Z,{disLoc:"right"},a.createElement(L.Z,{imgSrc:"./pics/buttons/data_division.png",onClick:function(){Zn.m8.push("/project_overview?projectId=".concat(M.curr.projectId))}},A("projectOverview")),a.createElement(L.Z,{imgSrc:"./pics/buttons/intelligent_interaction.png",disabled:!(m!=null&&m.labelMapping),onClick:function(){Ln(vn)}},A("autoInference")),a.createElement(_n.Z,{disabled:S.active,imgSrc:"./pics/buttons/threshold.png",disLoc:"left",size:b,maxSize:100,minSize:10,step:10,onChange:function(n){J(n)}},A("autoInferenceThreshold"))),a.createElement("div",{className:"rightSideBar"},a.createElement(Fn.Z,{labels:C.all,activeIds:C.activeIds,onLabelSelect:C.onSelect,onLabelDelete:C.remove,disabled:!1,onLabelAdd:function(n){C.create((0,B.Z)((0,B.Z)({},n),{},{projectId:M.curr.projectId})).then(function(t){E(void 0),C.setCurr(t)})}}),a.createElement($n.Z,{disabled:!1,type:"Detection",currAnnotation:e.curr,annotations:e.all,onAnnotationSelect:function(n){n!=null&&n.delete||E(n),Ae(n)},onAnnotationAdd:function(){console.log("onAnnotationAdd"),E(void 0)},onAnnotationModify:function(){},onAnnotationDelete:function(n){e.setAll(e.all.filter(function(t){return t.frontendId!=n.frontendId})),E(void 0),e.remove(n)}})))},oe=te},51505:function(fn,ln,u){"use strict";u.d(ln,{Z:function(){return q}});var B=u(67294),Cn=function(Q){return function(U,w){var a=(0,B.useRef)(!1);Q(function(){return function(){a.current=!1}},[]),Q(function(){if(!a.current)a.current=!0;else return U()},w)}},En=null,q=Cn(B.useEffect)}}]);
