(self.webpackChunkatoti_jupyterlab=self.webpackChunkatoti_jupyterlab||[]).push([[5880],{22276:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>gs});const n="Content-Type",o="application/json",i=(e,{requestInit:t={}}={})=>async(s,{body:i,contentType:r=o,method:a}={})=>{const c=`${e}${s.startsWith("/")?s:`/${s}`}`,d=await fetch(c,Object.assign(Object.assign({},t),{body:i,headers:Object.assign(Object.assign({},t.headers),r?{[n]:r}:{}),method:a}));if(!d.ok){const e=await d.json();throw console.error(e),new Error(`Unexpected response status: ${d.status}`)}const l=d.headers.get(n)===o;let u=await(l?d.json():d.text());return l&&"object"==typeof u&&"success"===u.status&&"data"in u&&(u=u.data),u},r="default",a="ROLE_ADMIN",c="ROLE_USER",d="anonymousUser";var l=s(74508);const u=e=>void 0!==e,h=(...e)=>{if(!window.__UNSTABLE_DATA_TEST_IDS_ENABLED__)return;const t=e[e.length-1];if((0,l.isPlainObject)(t)){const s=t["data-testid"],n=e.slice(0,-1).filter(u);if(s){const e=s.replace("atoti:","");return`atoti:${[...n.filter(u),e].join(":")}`}return`atoti:${n.join(":")}`}return`atoti:${e.filter(u).join(":")}`},g=s(16139).i8;var p=s(60362),m=s(4057),y=s(10309),f=s(34152),w=s(49082),b=s(39030),v=s(80973),x=s(63032);const j=e=>"mapping"in e;var C=s(71840),S=s(19567),k=s(76702),O=s(56271),M=s(5645);const E=(e,{getCurrentValue:t})=>{const s=(0,O.useCallback)((t=>e?(e.connect(t),()=>{e.disconnect(t)}):l.noop),[e]);return(0,M.useSubscription)({getCurrentValue:t,subscribe:s})},I=(e,{property:t,sender:s})=>{const n=(0,O.useCallback)((()=>{if(s)return s[t]}),[t,s]);return E(e,{getCurrentValue:n})};class P{constructor(e,t){this.onChange=t,this.index=0,this.states=[e]}get current(){return this.states[this.index]}get canRedo(){return this.index<this.states.length-1}get canUndo(){return this.index>0}set(e){e!==this.current&&(this.index++,this.states.length=this.index,this.states.push(e),this.onChange())}redo(){if(!this.canRedo)throw new Error("Cannot redo");this.index++,this.onChange()}undo(){if(!this.canUndo)throw new Error("Cannot undo");this.index--,this.onChange()}}const T="atoti",_="widget",L=360,R=e=>{var t;return null!==(t=e.get(T))&&void 0!==t?t:void 0},$=e=>{const t=e[_];return Object.assign(Object.assign({},e),{[_]:t?(0,w.mh8)(t):void 0})},D=e=>{const t=e[_];return Object.assign(Object.assign({},e),{[_]:t?(0,w.hNS)(t):void 0})},A=({code:e,state:t})=>({cell_type:"code",metadata:{[T]:D({[_]:t})},source:e}),U=e=>{var t,s;return null!==(s=null===(t=R(e))||void 0===t?void 0:t.height)&&void 0!==s?s:L};class N{constructor(e,{widgetPlugins:t}){this.cellMetadata=e,this._changed=new C.Signal(this),this._isDeferredChanged=new C.Signal(this),this._isDeferred=!1,this._isDisposed=!1,this.updatingState=!1;const s=R(this.cellMetadata);this.undoableState=new P(s?$(s):void 0,(()=>{this.updatingState=!0;try{this.current?this.cellMetadata.set(T,D(this.current)):this.cellMetadata.delete(T)}finally{this.updatingState=!1}this._changed.emit()}));const n=(e,{key:t,newValue:s})=>{t!==T||this.updatingState||(this.current=((e,t)=>{if(!t)return;const s=$(t);return e?(n=e,o=s,(0,k.produce)(n,(e=>{const t=(0,S.compare)(e,o);(0,S.applyPatch)(e,t)}))):s;var n,o})(this.current,s))};this.cellMetadata.changed.connect(n),this.disconnectFromCellMetadataChangedSignal=()=>{this.cellMetadata.changed.disconnect(n)},this.widgetPlugins=t}get defaultWidgetState(){return this.widgetPlugins[0].initialState}get canRedo(){return this.undoableState.canRedo}get canUndo(){return this.undoableState.canUndo}get changed(){return this._changed}get current(){return this.undoableState.current}set current(e){this.undoableState.set(e)}dispose(){this.isDisposed||(this._isDisposed=!0,this.disconnectFromCellMetadataChangedSignal(),C.Signal.clearData(this))}get isDeferred(){return this._isDeferred}set isDeferred(e){this._isDeferred=e,this._isDeferredChanged.emit()}get isDeferredChanged(){return this._isDeferredChanged}get isDisposed(){return this._isDisposed}setHeight(e){this.setMetadataProperty("height",e)}setWidgetState(e){this.setMetadataProperty(_,e)}redo(){this.undoableState.redo()}undo(){this.undoableState.undo()}setMetadataProperty(e,t){const{current:s}=this;this.current=Object.assign(Object.assign({},s),{[e]:t})}}const W=e=>{const t=I(e.isDeferredChanged,{property:"isDeferred",sender:e}),s=(0,O.useCallback)((t=>{e.isDeferred=t}),[e]);return{isDeferred:t,setIsDeferred:s}},q=e=>{var t;const s=(0,O.useCallback)((t=>{e.setWidgetState(t)}),[e]),{[_]:n}=null!==(t=I(e.changed,{property:"current",sender:e}))&&void 0!==t?t:{};return{setWidgetState:s,widgetState:n}};var B=s(8336),F=s(61162);const H=({children:e,description:t,icon:s,id:n})=>{const{formatMessage:o}=(0,x.useIntl)();return(0,B.jsx)("div",{css:{display:"flex",flexDirection:"column",height:"100%",justifyContent:"center"}},(0,B.jsx)(F.default,{description:(0,B.jsx)("span",{css:{color:"var(--jp-ui-font-color1)"}},(0,B.jsx)("span",{css:{fontSize:"var(--jp-ui-font-size2)"}},o({id:`${n}.title`})),(0,B.jsx)("br",null),(0,B.jsx)("span",{css:{color:"var(--jp-ui-font-color2)",fontSize:"var(--jp-ui-font-size1)"}},t||o({id:`${n}.description`}))),image:s,imageStyle:{fontSize:42,height:60}},e))};var z=s(48854);const K=({hasSnapshot:e})=>e?(0,B.jsx)(H,{icon:(0,B.jsx)(z.PictureOutlined,null),id:"widget.snapshotSelected"}):(0,B.jsx)(H,{icon:(0,B.jsx)(z.ApiOutlined,null),id:"widget.waitingForConnection"}),V=(0,O.createContext)(void 0),Q=()=>(0,O.useContext)(V),J=(0,O.createContext)(void 0),Y=({cellMetadata:e,children:t,hasSnapshot:s})=>{const n=Q(),o=(0,O.useCallback)((()=>n.get(e)),[e,n]),i=E(n.created,{getCurrentValue:o});return i?(0,B.jsx)(J.Provider,{value:i},t):(0,B.jsx)(K,{hasSnapshot:s})},Z=()=>(0,O.useContext)(J);class X{constructor({widgetPlugins:e}){this._created=new C.Signal(this),this.widgetStateTrackers=new WeakMap,this.widgetPlugins=e}get created(){return this._created}get(e){return this.widgetStateTrackers.get(e)}getOrCreate(e){return this.widgetStateTrackers.has(e)||(this.widgetStateTrackers.set(e,new N(e,{widgetPlugins:this.widgetPlugins})),this._created.emit()),this.get(e)}}const G=async({code:e,notebookTracker:t,state:s})=>{const n=t.currentWidget;if(!n)throw new Error("Notebook has no current panel.");const o=n.model;if(!o)throw new Error("Current notebook panel has no model.");const i=o.contentFactory.createCodeCell({cell:A({code:e,state:s})}),r=n.content;o.cells.insert(r.activeCellIndex+1,i),r.activeCellIndex++;const a=r.activeCell;return await y.NotebookActions.run(r,n.sessionContext),a},ee=e=>{const t=I(e.activeCellChanged,{property:"activeCell",sender:e});if(t&&(0,v.isCodeCellModel)(t.model))return t.model},te=(e,t)=>{for(let s=0;s<e.length;s++){const n=e.get(s);if(t(n))return n}};var se=s(78918);const ne="text/html",oe="0.7.2".split(".",1).pop(),ie=`application/vnd.atoti.link.v${oe}+json`,re=`application/vnd.atoti.widget.v${oe}+json`,ae=`application/vnd.atoti.convert-query-result-to-widget.v${oe}+json`,ce="atoti-sidebar",de=({jupyterLab:e})=>{e.shell.activateById(ce)};var le=s(72433);const ue="ant-root",he=(0,O.forwardRef)(((e,t)=>{var{children:s,height:n}=e,o=function(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(s[n[o]]=e[n[o]])}return s}(e,["children","height"]);return(0,B.jsx)("div",Object.assign({},o,{ref:t,className:ue,css:{height:n}}),s)}));var ge=s(64992),pe=s(68049),me=s(98310),ye=s(58964);const fe=()=>{const e=document.querySelector(`#${w.pt}`);if(!e)throw new Error("Missing overlay root DOM node.");return e};var we=s(97697);const be=we.PageConfig.getBaseUrl(),ve=we.URLExt.join(be,"proxy"),xe=async(e,{jupyterServerProxyEnabled:t})=>{const{hostname:s}=new URL(be),n="url"in e?e.url:`${e.https?"https":"http"}://${s}:${e.port}`,o=[];if(t&&!n.startsWith(ve)){const{hostname:e,pathname:t,port:i,protocol:r}=new URL(n),a=i||("https:"===r?"443":"80"),c=t&&"/"!==t?[t]:[];o.push(we.URLExt.join(ve,a,...c)),e!==s&&o.push(we.URLExt.join(ve,`${e}:${a}`,...c))}o.push(n);for(const e of o)try{const t=i(e);return{sessionUrl:e,versions:await t("versions/rest")}}catch(e){}throw new Error("Cannot access the session after trying "+(1===o.length?`this URL: ${o[0]}`:`these URLs: ${o.join(", ")}`))},je=(e,t="")=>{if(""===t){const{pathname:t}=new URL(e);return`${e}${""===t||"/"===t?"":"/"}`}return`${e}/${t}`};class Ce{constructor({activePivotClient:e,contentClient:t,fetch:s,id:n,isQuerySession:o,versions:i}){this._disposed=new C.Signal(this),this._isDisposed=!1,this.subscriberCount=0,this.activePivotClient=e,this.contentClient=t,this.fetch=s,this.stopSyncingDataModel=o?l.noop:(e=>{const t=`${e.url.replace(/^http/,"ws")}/atoti/discovery`;let s;const n=n=>{"connected"===n?(s=new WebSocket(t),s.addEventListener("message",(({data:t})=>{const s=JSON.parse(t);e.__UNSAFE_setDataModel__(s)}))):"disconnected"===n&&s&&(s.close(),s=void 0)};return n(e.connectionStatus),e.addConnectionStatusListener(n),()=>{e.removeConnectionStatusListener(n),s&&s.close()}})(e),this.id=n,this.isQuerySession=o,this.versions=i}static async create({jupyterServerProxyEnabled:e,sessionHeaders:t,sessionId:s,sessionLocation:n}){const o="url"in n;o||(e=>{const t=new Headers(e).get("authorization");if(!t)throw new Error(`Missing Authorization header in ${JSON.stringify(e)}.`);const{username:s}=(e=>{const{authorities:t,sub:s}=JSON.parse(atob(e.split(".",2).pop()));if(!(s!==d||t.includes(c)&&t.includes(a)))throw new Error(`Anonymous user should have roles ROLE_USER and ROLE_ADMIN but had roles: ${t}.`);return{username:s,userRoles:t}})(t.split(" ",2).pop());if(s!==d)throw new Error(`Expected username to be anonymousUser but was ${s}.`)})(t);const{sessionUrl:r,versions:l}=await xe(n,{jupyterServerProxyEnabled:e}),u=null===t?void 0:{credentials:"include",headers:t,mode:"cors"},[h,g]=["pivot","content"].map((e=>{const t=[`activeviam/${e}`,e];for(const e of t)if(e in l.apis)return l.apis[e].versions[0];throw new Error(`One of ${t} missing in the server services: ${Object.keys(l.apis)}.`)})),p=(0,w.Vse)({requestInit:u,url:r,version:h});await p.loadDataModel();const m=(0,w.u$l)({requestInit:u,url:r,version:g}),y=i(r,{requestInit:u});return new Ce({activePivotClient:p,contentClient:m,fetch:y,id:s,isQuerySession:o,versions:l})}dispose(){this.isDisposed||(this._isDisposed=!0,this._disposed.emit(),this.activePivotClient.disconnect(),this.stopSyncingDataModel(),C.Signal.clearData(this))}get disposed(){return this._disposed}get isDisposed(){return this._isDisposed}subscribe(){this.subscriberCount++}unsubscribe(){this.subscriberCount--,0===this.subscriberCount&&this.dispose()}}const Se=(0,O.createContext)(void 0),ke=()=>(0,O.useContext)(Se),Oe=(0,O.createContext)(void 0),Me={username:d,userRoles:[a,c]},Ee=({children:e,sessionId:t})=>{const s=ke(),n=(0,O.useCallback)((()=>s.get(t)),[s,t]),o=E(s.changed,{getCurrentValue:n}),i=(0,O.useMemo)((()=>{const e={};return o&&(e[r]=o.activePivotClient),e}),[o]),a=(0,O.useMemo)((()=>null==o?void 0:o.contentClient),[o]);return o?(0,B.jsx)(w.drd,{value:Me},(0,B.jsx)(w.u_E,{value:{activePivot:i,contentClient:a}},(0,B.jsx)(Oe.Provider,{value:o},e))):(0,B.jsx)(K,null)},Ie=()=>(0,O.useContext)(Oe);class Pe{constructor(){this._changed=new C.Signal(this),this.sessionClients={},this.sessionClientCreations={}}get changed(){return this._changed}get(e){return this.sessionClients[e]}async getOrCreate({jupyterServerProxyEnabled:e,sessionHeaders:t,sessionId:s,sessionLocation:n}){const o=this.get(s);if(o){const{activePivotClient:e}=o;return"disconnected"===e.connectionStatus&&await e.connect(),o}return s in this.sessionClientCreations||(this.sessionClientCreations[s]=(async()=>{const o=await Ce.create({jupyterServerProxyEnabled:e,sessionHeaders:t,sessionId:s,sessionLocation:n}),i=()=>{Reflect.deleteProperty(this.sessionClients,s),this._changed.emit(),o.disposed.disconnect(i)};o.disposed.connect(i),this.sessionClients[s]=o,Reflect.deleteProperty(this.sessionClientCreations,s),this._changed.emit()})()),await this.sessionClientCreations[s],this.sessionClients[s]}}const Te=(0,O.createContext)(void 0),_e=(0,O.createContext)(!1),Le=(0,O.createContext)(void 0),Re=({children:e,value:{intlTracker:t,jupyterLab:s,jupyterServerProxyEnabled:n,notebookTracker:o,pluginRegistry:i,sessionClients:r,themeTracker:a,widgetStateTrackers:c}})=>{const{locale:d,messages:l}=I(t.changed,{property:"config",sender:t}),u=I(a.changed,{property:"theme",sender:a});return(0,B.jsx)(ge.default,{getPopupContainer:fe},(0,B.jsx)(pe.DndProvider,{backend:me.HTML5Backend},(0,B.jsx)(x.IntlProvider,{locale:d,messages:l},(0,B.jsx)(w.f6W,{value:u},(0,B.jsx)(w.oPk,{value:i},(0,B.jsx)(Te.Provider,{value:s},(0,B.jsx)(_e.Provider,{value:n},(0,B.jsx)(Le.Provider,{value:o},(0,B.jsx)(Se.Provider,{value:r},(0,B.jsx)(V.Provider,{value:c},e))))))))))},$e=()=>(0,O.useContext)(Te),De=()=>(0,O.useContext)(_e),Ae=()=>(0,O.useContext)(Le);var Ue=s(21469),Ne=s(73317);const We=()=>{const e=Z(),{formatMessage:t}=(0,x.useIntl)();return(0,B.jsx)(H,{icon:(0,B.jsx)(z.MehOutlined,null),id:"widget.errored"},(0,B.jsx)(Ue.default,{danger:!0,onClick:()=>{e.current=void 0}},(0,B.jsx)(z.ClearOutlined,null)," ",t({id:"widget.reset"})),e.canUndo?(0,B.jsx)(Ue.default,{css:{marginLeft:"4px !important",marginTop:"4px !important"},onClick:()=>{e.undo()}},(0,B.jsx)(z.UndoOutlined,null)," ",t({id:"aui.plugins.menu-item.undo.key"})):null)},qe=({children:e,widgetLoadingTracker:t})=>{const s=(0,O.useCallback)((async e=>{t&&await t.handleError(e)}),[t]),n=Z(),o=q(n);return(0,B.jsx)(Ne.ErrorBoundary,{FallbackComponent:We,resetKeys:[o],onError:s},e)};var Be=s(94212),Fe=s(37788),He=s(93897),ze=s(10722);const{OptGroup:Ke,Option:Ve}=He.Z,Qe=({onChange:e,queryId:t,widgetState:s})=>{const{formatMessage:n}=(0,x.useIntl)(),o=(0,b.uU)({queryId:t,widgetState:s}),i=(e=>{const t=(0,w.h0_)(e),s=(0,O.useMemo)((()=>{const e=[];for(const s of t)(0,b.vo)(s)&&e.push(s);return e}),[t]);return s})((0,w.ANR)()),{mapping:r,widgetKey:a}=(0,w.jl5)(s),{attributes:c}=i.find((({key:e})=>e===a)),d=(0,O.useMemo)((()=>{var e,t;const a={};for(const d of Object.values(i)){const i=null!==(e=d.subCategory)&&void 0!==e?e:"misc";a[i]||(a[i]=[]);const l=null!==(t=d.Icon)&&void 0!==t?t:z.QuestionOutlined,{maxNumberOfFields:u,status:h}=(0,b.WS)(r,c,d);a[i].push((0,B.jsx)(Ve,{key:d.key,disabled:"ok"!==h,value:d.key},(0,B.jsx)(ze.default,{title:(0,B.jsx)(b.jW,{isQueryLazyLoaded:o,selectedWidgetState:s,widgetOption:Object.assign(Object.assign({},d),{disabledType:"tooManyNumeric"===h?"numeric":"ordinal",isSwitchDisabled:"ok"!==h,maxNumberOfFields:u})})},(0,B.jsx)(l,{css:{marginRight:4}})," ",n({id:`aui.plugins.widget.${d.key}.key`}))))}return a}),[c,i,n,o,r,s]);return(0,B.jsx)(He.Z,{css:{height:28,marginBottom:"4px !important",width:"100%"},listHeight:30*Object.keys(i).length,value:a,onChange:t=>{e((0,k.produce)(s,(e=>{t===e.widgetKey?delete e.switchedTo:e.switchedTo=t})))}},Object.entries(d).map((([e,t])=>(0,B.jsx)(Ke,{key:e,label:n({id:`aui.dataVisualization.category.${e}`})},t))))};var Je=s(64994);const Ye=()=>{const e=Z(),{isDeferred:t,setIsDeferred:s}=W(e),{formatMessage:n}=(0,x.useIntl)();return(0,B.jsx)("div",{css:{alignItems:"center",display:"flex",flexDirection:"row",height:22,justifyContent:"flex-end"}},(0,B.jsx)(Je.Z,{checked:t,onChange:e=>{s(e.target.checked)}},n({id:"sidebar.deferUpdates"})))},{Panel:Ze}=Fe.Z,Xe=({cellId:e,widgetName:t})=>{const{formatMessage:s}=(0,x.useIntl)(),n=(0,w.FgM)(),o=Z(),{setWidgetState:i,widgetState:r=o.defaultWidgetState}=q(o),a=(0,O.useMemo)((()=>Object.assign(Object.assign({},r),{name:t})),[t,r]),{widgetKey:c}=(0,w.jl5)(r),[d]=(0,w.h0_)([c]),[l,u]=(0,O.useState)(!0),h=(0,O.useCallback)((e=>{u(!e.includes("0"))}),[]),g=(0,O.useRef)(null),p=(0,Be.zM)(g),{contentEditor:m,styleEditor:y}=d;if(!m)throw new Error(`All widgets in this extension are expected to have a Content Editor but widget ${c} does not.`);return(0,B.jsx)("div",{css:{display:"flex",flexDirection:"column-reverse",height:"100%",overflowY:l?void 0:"scroll",paddingTop:4}},y?(0,B.jsx)(Fe.Z,{ghost:!0,activeKey:l?void 0:"0",css:{backgroundColor:`${n.grayScale[1]} !important`,height:l?36:void 0},onChange:h},(0,B.jsx)(Ze,{key:"0",css:{".ant-collapse-header":{color:`${n.textColor} !important`}},header:(0,B.jsx)(w.Dxz,{level:3},(0,B.jsx)(z.BgColorsOutlined,null)," ",s({id:"sidebar.style"}))},(0,B.jsx)(y,{widgetState:r,queryId:e,onWidgetChange:i}))):null,(0,B.jsx)("div",{css:{paddingLeft:4,paddingRight:4}},(0,B.jsx)(Ye,null)),(0,B.jsx)("div",{ref:g,css:{height:`calc(100% - ${22+(j(r)?32:0)+(y?36:0)}px)`,paddingLeft:4,paddingRight:4}},(0,B.jsx)("div",{css:{height:p.height}},(0,B.jsx)(m,{widgetState:r,queryId:e,onWidgetChange:i}))),j(a)?(0,B.jsx)("div",{css:{paddingLeft:4,paddingRight:4}},(0,B.jsx)(Qe,{queryId:e,widgetState:a,onChange:i})):null)},Ge=()=>{var e;const t=Ae(),s=ee(t),n=(e=>{I(null==e?void 0:e.outputs.changed,{property:"length",sender:null==e?void 0:e.outputs});const t=e?te(e.outputs,(e=>void 0!==e.data[re])):void 0;if(!t)return;const{data:s}=t;return{hasSnapshot:ne in s,widgetOutput:s[re]}})(s);if(!s||!n)return(0,B.jsx)(H,{icon:(0,B.jsx)(w.Iwf,null),id:"sidebar.noWidgetSelected"});const{hasSnapshot:o,widgetOutput:i}=n;return(0,B.jsx)(Y,{cellMetadata:s.metadata,hasSnapshot:o},(0,B.jsx)(Ee,{sessionId:i.sessionId},(0,B.jsx)(qe,null,(0,B.jsx)(Xe,{cellId:s.id,widgetName:null!==(e=i.name)&&void 0!==e?e:void 0}))))},et=".atoti-icon.jp-SideBar-tabIcon";class tt extends le.Widget{constructor(e){super(),this.id=ce,this.title.caption="atoti",this.title.iconClass="jp-SideBar-tabIcon atoti-icon";const t=m.ReactWidget.create((0,B.jsx)(O.Fragment,null,(0,B.jsx)(B.Global,{styles:{[et]:{backgroundColor:"var(--md-grey-700)",backgroundImage:"none",maskImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24'%3E%3Cg%3E%3Cpath d='M.24 11.88c0-4.43 2.74-7.82 7.05-7.82 1.9-.09 3.7.88 4.65 2.52V4.46h4.68V19.3h-4.68v-2.09c-.8 1.48-2.65 2.49-4.71 2.49-4.43 0-6.99-3.35-6.99-7.82m11.89 0c0-2.13-1.2-3.88-3.54-3.88-2.19 0-3.54 1.63-3.54 3.88s1.35 3.91 3.54 3.91c2.34 0 3.54-1.75 3.54-3.91' /%3E%3Cpath d='M17.91 16.81a2.917 2.917 0 012.96-2.88c1.58.02 2.86 1.3 2.89 2.88a2.947 2.947 0 01-2.97 2.89 2.929 2.929 0 01-2.88-2.89' /%3E%3C/g%3E%3C/svg%3E%0A\")",maskPosition:"center",maskRepeat:"no-repeat",maskSize:"contain"},[`[data-jp-theme-light="false"] ${et}`]:{backgroundColor:"var(--md-grey-300)"}}}),(0,B.jsx)(Re,{value:e},(0,B.jsx)(Ge,null)))),{classList:s,style:n}=t.node;s.add(ue),n.padding="0";const o=new le.PanelLayout;o.addWidget(t),this.layout=o}}const st="convert-query-result-to-widget",nt=`atoti:${st}`,ot=".jp-Notebook .jp-CodeCell .dataframe",it=e=>{const{activeCell:t}=e,s=t&&(0,v.isCodeCellModel)(t.model)&&te(t.model.outputs,(e=>void 0!==e.data[ae]));return s?s.data[ae]:void 0};var rt=s(20391);const at="en-US",ct={en:"en-US"},dt=e=>{if(!e)return at;const t=e.get("locale").composite,s=ct[t];return void 0===s?(console.error(`atoti does not support JupyterLab's ${t} locale, falling back to en-US.`),at):s},lt=async(e,{pluginRegistry:t})=>{const[n,{default:o}]=await Promise.all([(0,w.pr1)(e),s(7147)(`./${e}`)]);return Object.assign(Object.assign(Object.assign({},n),(0,w.dUG)(t,e)),(0,rt.treeToFlatMap)(o))};class ut{constructor({initialConfig:e,pluginRegistry:t,translationSettings:s}){this._changed=new C.Signal(this),this._config=e,s&&s.changed.connect((async()=>{const e=dt(s),n=await lt(e,{pluginRegistry:t});this._config={locale:e,messages:n},this._changed.emit()}))}static async create({pluginRegistry:e,settingRegistry:t}){const s=await(t?t.load("@jupyterlab/translation-extension:plugin"):void 0),n=dt(s),o=await lt(n,{pluginRegistry:e});return new ut({initialConfig:{locale:n,messages:o},pluginRegistry:e,translationSettings:s})}get changed(){return this._changed}get config(){return this._config}}const ht=we.URLExt.join(we.PageConfig.getBaseUrl(),"server-proxy","servers-info"),gt=async()=>{try{if((await fetch(ht)).ok)return!0}catch(e){}return!1};var pt=s(15923),mt=s(14456),yt=s.n(mt);const ft=({output:{path:e,sessionLocation:t}})=>{const s=De(),[n,o]=(0,O.useState)(),[i,r]=(0,O.useState)();if((0,O.useEffect)((()=>{(async()=>{try{const{sessionUrl:e}=await xe(t,{jupyterServerProxyEnabled:s});o(e)}catch(e){r(e)}})()}),[s,t]),void 0!==i)return(0,B.jsx)("div",{css:{paddingLeft:"var(--jp-code-padding)"}},i.message);if(void 0===n)return null;const a=je(n,e);return(0,B.jsx)("div",{css:{paddingLeft:"var(--jp-code-padding)"}},(0,B.jsx)("pre",null,(0,B.jsx)("a",{css:{":hover":{color:"var(--jp-content-link-color)",textDecoration:"underline"},color:"var(--jp-content-link-color)"},"data-testid":h("Link"),href:a,target:"_blank",rel:"noopener noreferrer"},a)))};class wt extends y.NotebookTools{constructor(e){super({tracker:e.notebookTracker}),this.sharedContext=e}async renderModel(e){return new Promise((t=>{yt().render((0,B.jsx)(Re,{value:this.sharedContext},(0,B.jsx)(ft,{output:e.data[ie]})),this.node,t)}))}onBeforeDetach(){yt().unmountComponentAtNode(this.node)}}class bt{constructor(e){this.sharedContext=e}createNew(e,t){return e.content.rendermime.addFactory({createRenderer:()=>new wt(this.sharedContext),defaultRank:0,mimeTypes:[ie],safe:!1}),new pt.DisposableSet}}var vt=s(95479),xt=s(36853),jt=s(22355);const Ct=(0,O.createContext)(null),St=Ct.Provider,kt=()=>(0,O.useContext)(Ct),Ot="open-drillthrough",Mt={Component:(0,w.r3w)((e=>{const{cube:t,onClick:s,selection:n,widgetState:o}=e,{formatMessage:i}=(0,x.useIntl)(),a=$e(),c=Ae(),{mimeModel:d}=kt(),{widgetCreationCode:l}=d.data[re],u=(0,O.useMemo)((()=>{if((0,xt.Yi)(n))return n.cells[0].tuple.filter((e=>"Measures"===e.dimensionName||!(0,vt.Eu)((0,w._yD)(e,t),e)))}),[t,n]),h=(0,O.useMemo)((()=>{if(!u)return;const e=u.filter((e=>"Measures"!==e.dimensionName));return i({id:`aui.plugins.menu-item.${Ot}.openDrillthrough`},{member:e.length>0?(0,vt.eh)(e,{cube:t,hasOnlyCaptionForLeafLevels:!0,separator:", "}):void 0})}),[i,u,t]),g=(0,O.useCallback)((async e=>{if(s&&s(e),h&&u&&o.query.mdx){const e=(0,xt.j6)({cube:t,sourceWidgetFilters:o.filters,tuple:u}),s=Object.assign(Object.assign({},w.oH_.initialState),{filters:e,query:Object.assign(Object.assign({},w.oH_.initialState.query),{mdx:{elementType:"Drillthrough",select:Object.assign(Object.assign({},o.query.mdx),{axes:[],cellProps:void 0,slicerAxis:void 0})}}),serverKey:r});de({jupyterLab:a}),await G({code:l,notebookTracker:c,state:s})}}),[t,a,h,c,s,u,l,o]);return u&&o.query.mdx?(0,B.jsx)(jt.Z.Item,Object.assign({},(0,w.IWr)(e),{onClick:g}),(0,B.jsx)(w.Al8,{css:{marginRight:8}}),h):null})),key:Ot,translations:{"en-US":{openDrillthrough:"Drillthrough {member, select,\n           undefined {}\n           other {on {member}}\n          }"}}};var Et=s(35411),It=s(86973),Pt=s(65096);const{Text:Tt}=Pt.Z,_t={Component:e=>{const{formatMessage:t,locale:s,messages:n}=(0,x.useIntl)(),{activePivotClient:{url:o},contentClient:i,isQuerySession:r}=Ie(),{widgetName:c}=kt(),[d,l]=(0,O.useState)(!1),{widgetState:u}=e,h=(0,O.useCallback)((()=>{let e=!1;return(async()=>{if(!i)throw new Error("Missing content client on local sessions.");l(!0);const r=(0,w.hNS)(u),{name:d,widgetKey:h}=r,g=function(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(s[n[o]]=e[n[o]])}return s}(r,["name","widgetKey"]),p=()=>{e||l(!1)},m=[a];try{await i.createFile({content:g,metaData:{name:null!=c?c:void 0,widgetKey:h},owners:m,pathToFolder:[],readers:m,type:"widget"});const e=je(o);It.default.success({description:(0,B.jsx)(x.IntlProvider,{locale:s,messages:n},(0,B.jsx)(x.FormattedMessage,{id:"aui.plugins.menu-item.publish-widget.successDescription",values:{a:t=>(0,B.jsx)("a",{href:e,target:"_blank",rel:"noopener noreferrer"},t),b:e=>(0,B.jsx)(Tt,{strong:!0},e),i:()=>(0,B.jsx)(w.Iwf,null)}})),getContainer:fe,message:t({id:"aui.plugins.menu-item.publish-widget.successMessage"}),onClose:p})}catch(e){console.error(e),It.default.error({description:String(e),getContainer:fe,message:t({id:"aui.plugins.menu-item.publish-widget.errorMessage"}),onClose:p})}})(),()=>{e=!0}}),[i,t,s,n,o,c,u]);return(0,B.jsx)(Et.default,Object.assign({},(0,w.IWr)(e),{disabled:r||d,title:r?t({id:"aui.plugins.menu-item.publish-widget.querySessionWidgetsCannotBePublished"}):void 0,onClick:h}),(0,B.jsx)(O.Fragment,null,(0,B.jsx)(z.ShareAltOutlined,null),t({id:"aui.plugins.menu-item.publish-widget.publishWidgetInApp"})))},key:"publish-widget",translations:{"en-US":{errorMessage:"Widget could not be published",publishWidgetInApp:"Publish in app",querySessionWidgetsCannotBePublished:"Query session widgets cannot be published",successDescription:"Go to <a>the app</a>, create or open a dashboard, and click on the <b><i>icon</i> Widgets</b> icon in the <b>Left bar</b> to find your widget.",successMessage:"Widget published"}}},Lt=e=>(0,l.keyBy)(e,"key"),Rt=["undo","redo"];const $t=e=>{var{undoRedoKey:t}=e,s=function(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(s[n[o]]=e[n[o]])}return s}(e,["undoRedoKey"]);const{formatMessage:n}=(0,x.useIntl)(),o=Z();I(o.changed,{property:"current",sender:o});const i=(0,O.useCallback)((()=>{"undo"===t?o.undo():o.redo()}),[t,o]),r="undo"===t?!o.canUndo:!o.canRedo;return(0,B.jsx)(Et.default,Object.assign({},(0,w.IWr)(s),{disabled:!o||r,title:r?n({id:`aui.plugins.menu-item.${t}.nothingToUndoRedo`}):void 0,onClick:i}),"undo"===t?(0,B.jsx)(z.UndoOutlined,null):(0,B.jsx)(z.RedoOutlined,null),n({id:`aui.plugins.menu-item.${t}.key`}))},Dt=(e,{notebookTracker:t,widgetStateTrackers:s})=>n=>{const o=ee(t);return o?(0,B.jsx)(V.Provider,{value:s},(0,B.jsx)(Y,{cellMetadata:o.metadata},(0,B.jsx)($t,Object.assign({undoRedoKey:e},n)))):null},At=[w.TA$,w.a2P,w._ll,w._dN,w.Uou,w.igv,w.W$X,w.$3o,w.GSY,w.Y8R,w.uVH,w.fO6,w.U_o,w.UiH,w.Y5x,w.EAR,w.M1w,w.Oj0,w.NWu,w.iph,w.wSQ,w.teE,w.C1v,w.oH_];w.oH_.cellStyle=w.iOR.key,w.oH_.contextMenuItems=[w._fi.key,w.A8w.key,w.Pmi.key,_t.key];const Ut=At.filter((({key:e})=>e.startsWith("plotly")));for(const e of Ut)e.contextMenuItems=[...Rt,w.mPM.key,Mt.key,w.Uk4.key,w.QYw.key,w.f$L.key,w.XWS.key,w.hkS.key,w.lJ3.key,_t.key];w.TA$.cell=w.gRB.key,w.TA$.cellStyle=w.OT2.key,w._ll.cell=w.ASS.key,w._ll.cellStyle=w.eyx.key,w.a2P.cell=w.BUk.key,w.a2P.cellStyle=w.OT2.key;const Nt=[...Rt,w.mPM.key,Mt.key,w.f$L.key,w.XWS.key,w.hkS.key,w.oCn.key,w.lJ3.key,_t.key];for(const e of[w.TA$,w.a2P])e.contextMenuItems=[w.Nn4.key,w.woi.key,...Nt];w._ll.contextMenuItems=[w.WaG.key,w.yNZ.key,...Nt],w._dN.contextMenuItems=[...Rt,w.mPM.key,Mt.key,w.XWS.key,w.oCn.key,w.hkS.key,w.lJ3.key,_t.key];const Wt="atoti-ant-style",qt=async e=>{e.theme||(await new Promise((t=>{const s=()=>{e.themeChanged.disconnect(s),t(void 0)};e.themeChanged.connect(s)})),await qt(e))};class Bt{constructor({initialTheme:e,syncTheme:t,themeManager:s}){this._changed=new C.Signal(this),this._theme=e,s.themeChanged.connect((async()=>{this._theme=await t(),this._changed.emit()}))}static async create(e){const t=document.createElement("style");t.id=Wt,t.setAttribute("rel","stylesheet"),document.querySelector("head").append(t),await qt(e);const n=async()=>{const n=!e.theme||e.isLight(e.theme),o=n?await s.e(674).then(s.t.bind(s,90674,17)):await s.e(3740).then(s.t.bind(s,93740,17));return t.innerHTML=o.default,n?w.xjl:w.MuJ},o=await n();return new Bt({initialTheme:o,syncTheme:n,themeManager:e})}get changed(){return this._changed}get theme(){return this._theme}}class Ft{constructor({cellModels:e}){this._changed=new C.Signal(this),this.messages=new WeakMap,this.cellModels=e}get changed(){return this._changed}get(e){return this.messages.get(e)}register(e){this._changed.emit(),e.registerCommTarget("atoti-widget",((e,{content:{data:t}})=>{const s=t;try{const{cellId:e}=s,t=(0,se.toArray)(this.cellModels).find((({id:t})=>e===t));if(!t)throw new Error(`Missing model for cell #${e}`);if(!(0,v.isCodeCellModel)(t))throw new Error(`Expected cell #${e} to be a code cell`);const n=te(t.outputs,(e=>void 0!==e.data[re]));if(!n)throw new Error(`Expected cell #${e} to have a widget output`);this.messages.set(n,s),this._changed.emit()}catch(e){console.error(e)}}))}}const Ht=({children:e})=>{const[t,s]=(0,O.useState)(),n=(0,O.useRef)(null);return(0,O.useEffect)((()=>{const e=n.current;e&&void 0===t&&s(null!==e.closest(".jp-LinkedOutputView"))}),[t]),void 0===t?(0,B.jsx)("div",{ref:n}):e(t)};var zt=s(27231);const Kt={"*":{"-ms-overflow-style":"none","scrollbar-width":"none"},"*::-webkit-scrollbar":{display:"none"}},Vt="http://www.w3.org/2000/svg",Qt=(e,{elements:t,matchedSelectors:s,styles:n})=>{const o=e.selectorText,i=e.style;if(((e,{elements:t,matchedSelectors:s})=>{if(e in s)return s[e];const n=t.some((t=>t.matches(e)));return s[e]=n,s[e]})(o,{elements:t,matchedSelectors:s})){o in n||(n[o]={});const e=n[o];for(const t of i)e[t]=`${i.getPropertyValue(t)}${"important"===i.getPropertyPriority(t)?" !important":""}`}},Jt={left:"scrollLeft",top:"scrollTop"},Yt=e=>{const{clientHeight:t,clientWidth:s}=e,n=document.createElementNS(Vt,"svg");n.setAttribute("xmlns",Vt);const o=document.createElementNS(Vt,"foreignObject");n.setAttribute("height",String(t)),n.setAttribute("width",String(s)),o.setAttribute("width","100%"),o.setAttribute("height","100%"),o.setAttribute("x","0"),o.setAttribute("y","0");const i=document.createElement("style"),r=(e=>{if(!document.getElementById(Wt))throw new Error("The stylesheet #atoti-ant-style is missing");const t={},s={},n=[e,...e.querySelectorAll("*")],o=[...document.styleSheets];for(const e of o)try{const o=e.cssRules;for(const e of o)Qt(e,{elements:n,matchedSelectors:t,styles:s})}catch(e){}return s})(e),a=(c=Object.assign(Object.assign(Object.assign({},r),Kt),{".atoti-hidden-in-snapshot":{display:"none"}}),Object.entries(c).map((([e,t])=>`${e} {${Object.entries(t).map((([e,t])=>`${e}: ${t}`)).join("; ")}}`)).join("\n"));var c;i.setAttribute("type","text/css"),i.append(document.createTextNode(a)),n.append(o),o.append(i);const d=document.createElement("div");return d.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),d.setAttribute("style",`height: ${t}px; width: ${s}px;`),d.append((e=>{const t=[e,...e.querySelectorAll("*")],s=e.cloneNode(!0),n=[s,...s.querySelectorAll("*")];for(const[e,s]of n.entries()){const n=t[e];for(const[e,t]of Object.entries(Jt)){const o=e,i=n[t];if(0!==i)for(const e of s.children){const{style:s}=e;if(""!==s[o])throw new Error(`Expected child of element with ${t} property of ${i} to have no ${o} style property but has ${s[o]}.`);s[o]=-i+"px"}}}return s})(e)),o.append(d),n},Zt=e=>{const t=document.createElementNS(Vt,"svg");return t.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),t.setAttribute("height",String(e.clientHeight)),t.setAttribute("width",String(e.clientWidth)),((e,t)=>{const{height:s,width:n}=e[0].getBoundingClientRect();t.setAttribute("viewBox",`0 0 ${n} ${s}`);for(const s of e)for(const e of s.children)t.append(e.cloneNode(!0))})(e.querySelectorAll(".svg-container .main-svg"),t),t},Xt=(e,{isPlotlyChart:t})=>(e=>{const t=(new XMLSerializer).serializeToString(e);return`<img src="data:image/svg+xml;charset=utf8,${encodeURIComponent(`<?xml version="1.0" standalone="no"?>${t}`)}">`})((t?Zt:Yt)(e)),Gt=({children:e})=>{const{formatMessage:t}=(0,x.useIntl)(),s=(()=>{const e=Ae(),t=ee(e),{cellMetadata:s}=kt();return!!t&&t.metadata===s})(),{[r]:n}=(0,w.ZmX)(),[o,i]=(0,O.useState)(!1),a=(0,O.useCallback)((()=>{i(!0)}),[]),c="disconnected"===n;return(0,O.useEffect)((()=>{i(!c)}),[c]),(0,B.jsx)(O.Fragment,null,s&&c&&!o?(0,B.jsx)("div",{css:{padding:4,position:"absolute",width:"100%",zIndex:1},className:"atoti-hidden-in-snapshot"},(0,B.jsx)(zt.default,{closable:!0,showIcon:!0,message:t({id:"widget.sessionDisconnected"}),type:"warning",onClose:a})):null,e)},es=({children:e,widgetLoadingTracker:t})=>(0,B.jsx)(Gt,null,(0,B.jsx)(qe,{widgetLoadingTracker:t},e)),ts=()=>{const{queryId:e}=kt(),t=Z(),{isDeferred:s}=W(t),{setWidgetState:n,widgetState:o=t.defaultWidgetState}=q(t);return(0,B.jsx)(w.$LY,{isDeferred:s,queryId:e,widgetState:o,onChange:n})},ss=()=>{const{cellMetadata:e,mimeModel:t,sessionId:s}=kt();return(0,B.jsx)(he,null,(0,B.jsx)(Y,{cellMetadata:e,hasSnapshot:Boolean(t.data["text/html"])},(0,B.jsx)(Ee,{sessionId:s},(0,B.jsx)(es,null,(0,B.jsx)(ts,null)))))};class ns{constructor({sessionClient:e,widgetId:t}){this.toldLoadingDone=!1,this.sessionClient=e,this.widgetId=t}async done(){if(this.toldLoadingDone||this.sessionClient.isQuerySession)return;this.toldLoadingDone=!0;const e=`${this.sessionClient.versions.apis.atoti.versions[0].restPath}/widgets/${this.widgetId}/loading`;await this.sessionClient.fetch(e,{method:"DELETE"})}async handleError(e){await this.done()}}const os=({widgetLoadingTracker:e,widgetRef:t})=>{const{queryId:s}=kt(),n=Z(),{isDeferred:o,setIsDeferred:i}=W(n),{setWidgetState:a,widgetState:c}=q(n),d=null!=c?c:n.defaultWidgetState,l=(g=e,(0,O.useEffect)((()=>()=>{(async()=>{await g.done()})()}),[g]),(0,O.useCallback)((async()=>{await g.done()}),[g])),u=(({widgetRef:e,widgetState:t})=>{const{mimeModel:s,queryId:n,saveStateSignal:o}=kt(),{widgetKey:i}=(0,w.jl5)(t),a=(0,O.useRef)(!1),c=(0,O.useCallback)((e=>{const t=s.data,n=ne,o=(t[n],function(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(s[n[o]]=e[n[o]])}return s}(t,[n+""]));s.setData({data:void 0===e?o:Object.assign(Object.assign({},o),{[ne]:e})})}),[s]),{error:d}=(0,w.bAZ)({queryId:n,serverKey:r});return(0,O.useEffect)((()=>{const t=(t,s)=>{"started"===s&&c(a.current&&!d&&e.current?Xt(e.current,{isPlotlyChart:/plotly-.+-chart/.test(i)}):void 0)};return o.connect(t),()=>{o.disconnect(t)}}),[d,o,c,e,i]),(0,O.useCallback)((()=>{a.current=!0}),[])})({widgetRef:t,widgetState:d}),h=(0,O.useCallback)((()=>{l(),u()}),[l,u]);var g;return(e=>{const t=$e();(0,O.useEffect)((()=>{e&&de({jupyterLab:t})}),[e,t])})(void 0===c),(e=>{(0,O.useEffect)((()=>()=>{e(!1)}),[e])})(i),(()=>{const e=Ie();(0,O.useEffect)((()=>(e.subscribe(),()=>{e.unsubscribe()})),[e])})(),(0,B.jsx)(w.$LY,{isDeferred:o,queryId:s,widgetState:d,onLoaded:h,onChange:a})};var is=s(57595);const rs=(0,O.forwardRef)((({children:e},t)=>{const s=Z(),{height:n,setHeight:o}=(e=>{var t;const s=(0,O.useCallback)((t=>{e.setHeight(t)}),[e]),{height:n=L}=null!==(t=I(e.changed,{property:"current",sender:e}))&&void 0!==t?t:{};return{height:n,setHeight:s}})(s),{widgetName:i}=kt(),r=(0,w.FgM)();return(0,B.jsx)(B.ClassNames,null,(({css:s})=>(0,B.jsx)(is.Resizable,{handleClasses:{bottom:`atoti-resize-handle ${s({backgroundColor:r.grayScale[6],borderRadius:2,borderTop:"unset",height:"4px !important",marginBottom:6,marginLeft:"calc(50% - 16px)",opacity:.4,width:"32px !important"})}`},size:{height:n,width:"100%"},enable:{bottom:!0,bottomLeft:!1,bottomRight:!1,left:!1,right:!1,top:!1,topLeft:!1,topRight:!1},css:{"&:hover .atoti-resize-handle":{display:"inherit"},overflow:"hidden",paddingBottom:8},onResizeStop:(e,t,s,i)=>{o(n+i.height)}},(0,B.jsx)(he,{ref:t,"data-testid":h("Widget",i)},e))))})),as=({html:e})=>{const t=(0,x.useIntl)(),{widgetName:s}=kt();return(0,B.jsx)("div",{dangerouslySetInnerHTML:{__html:e},css:{cursor:"help"},"data-testid":h("WidgetSnapshot",s),title:t.formatMessage({id:"widget.snapshotSelected.description"})})},cs=()=>{const e=(0,O.useRef)(null),{cellMetadata:t,mimeModel:s,sessionId:n}=kt(),o=(()=>{const e=De(),t=ke(),{cellMetadata:s,mimeModel:n,sessionId:o,sessionLocation:i,widgetComm:r}=kt(),a=Q(),c=((e,t)=>{const s=(0,O.useCallback)((()=>e.get(t)),[t,e]);return E(e.changed,{getCurrentValue:s})})(r,n),[d,l]=(0,O.useState)(),[u,h]=(0,O.useState)();return(0,O.useEffect)((()=>{let n=!1;return(async()=>{if(u||!c||d)return;const{sessionHeaders:r,widgetId:g}=c;try{const c=await t.getOrCreate({jupyterServerProxyEnabled:e,sessionHeaders:r,sessionId:o,sessionLocation:i});a.getOrCreate(s),n||d||l(new ns({sessionClient:c,widgetId:g}))}catch(e){h(e instanceof Error?e:new Error(String(e)))}})(),()=>{n=!0}}),[s,u,e,t,o,i,c,d,a]),u||d})(),i=Q().get(t);return o instanceof Error?(0,B.jsx)(he,{height:U(t)},(0,B.jsx)(H,{description:o.message,icon:(0,B.jsx)(z.DisconnectOutlined,null),id:"widget.connectionFailed"})):o&&i?(0,B.jsx)(Y,{cellMetadata:t},(0,B.jsx)(rs,{ref:e},(0,B.jsx)(Ee,{sessionId:n},(0,B.jsx)(es,{widgetLoadingTracker:o},(0,B.jsx)(os,{widgetLoadingTracker:o,widgetRef:e}))))):s.data["text/html"]?(0,B.jsx)(as,{html:s.data["text/html"]}):(0,B.jsx)(he,{height:U(t)},(0,B.jsx)(K,null))},ds=()=>(0,B.jsx)(Ht,null,(e=>e?(0,B.jsx)(ss,null):(0,B.jsx)(cs,null)));class ls extends y.NotebookTools{constructor({cellModels:e,notebookContext:t,sharedContext:s,widgetComm:n}){super({tracker:s.notebookTracker}),this.cleanUpFunctions=[],this.cellModels=e,this.notebookContext=t,this.sharedContext=s,this.widgetComm=n}async renderModel(e){const{id:t,metadata:s}=((e,{cellModels:t})=>{const s=(0,se.toArray)(t).filter(v.isCodeCellModel).find((({outputs:t})=>te(t,(t=>t===e))));if(!s)throw new Error(`Could not find matching cell for model: ${JSON.stringify(e)}`);return s})(e,{cellModels:this.cellModels}),n=e.data[re],{name:o,sessionId:i,sessionLocation:r}=n;return new Promise((n=>{yt().render((0,B.jsx)(Re,{value:this.sharedContext},(0,B.jsx)(St,{value:{cellMetadata:s,mimeModel:e,queryId:t,saveStateSignal:this.notebookContext.saveState,sessionId:i,sessionLocation:r,widgetComm:this.widgetComm,widgetName:o}},(0,B.jsx)(ds,null))),this.node,(()=>{this.cleanUpFunctions.push((()=>{yt().unmountComponentAtNode(this.node)})),n()}))}))}handleEvent(e){if(e instanceof MouseEvent&&!e.shiftKey&&e.target){const t=new MouseEvent("contextmenu",{bubbles:!0,clientX:e.clientX,clientY:e.clientY,shiftKey:!0});e.stopPropagation(),e.preventDefault(),t.initEvent(t.type,!0,!0),e.target.dispatchEvent(t)}}onAfterAttach(){const e={capture:!0};this.node.addEventListener("contextmenu",this,e),this.cleanUpFunctions.push((()=>{this.node.removeEventListener("contextmenu",this,e)}))}onBeforeDetach(){for(const e of this.cleanUpFunctions)e()}}class us{constructor(e){this.sharedContext=e}createNew(e,t){const{content:s,model:n}=e;if(null===n)throw new Error("Session model should not be null at this time");const{cells:o}=n,i=new Ft({cellModels:o});s.rendermime.addFactory({createRenderer:()=>new ls({cellModels:o,notebookContext:t,sharedContext:this.sharedContext,widgetComm:i}),defaultRank:0,mimeTypes:[re],safe:!1});const{sessionContext:r}=t,a=(e,{newValue:t})=>{t&&i.register(t)};r.kernelChanged.connect(a);const c=((e,{cellModels:t})=>(s,n)=>{if("idle"===n)for(const s of(0,se.toArray)(t).filter((t=>{const s=e.get(t.metadata);return(null==s?void 0:s.current)&&(0,v.isCodeCellModel)(t)&&t.outputs.length>0&&!te(t.outputs,(e=>"error"===e.type||void 0!==e.data[re]))})))e.get(s.metadata).current=void 0})(this.sharedContext.widgetStateTrackers,{cellModels:o});return r.statusChanged.connect(c),new pt.DisposableDelegate((()=>{r.kernelChanged.disconnect(a),r.statusChanged.disconnect(c)}))}}const hs={async activate(e,t,s,n,o,i){window.localStorage.getItem("_atotiEnableTestIds")===JSON.stringify(!0)&&(window.__UNSTABLE_DATA_TEST_IDS_ENABLED__=!0);const a=e,{docRegistry:c,shell:d}=a;console.debug(`Activating atoti extension 0.7.2 (relying on ActiveUI SDK ${g})`);const l=new X({widgetPlugins:At}),u=(({notebookTracker:e,widgetStateTrackers:t})=>Rt.map((s=>({Component:Dt(s,{notebookTracker:e,widgetStateTrackers:t}),key:s,translations:{"en-US":{key:"undo"===s?"Undo":"Redo",nothingToUndoRedo:"Nothing to "+("undo"===s?"undo":"redo")}}}))))({notebookTracker:t,widgetStateTrackers:l}),h=(({undoRedoMenuItemPlugins:e,widgetPlugins:t})=>({cell:Lt([w.gRB,w.ASS,w.BUk]),"cell-style":Lt([w.iOR,w.OT2,w.eyx]),"menu-item":Lt([w.XWS,w.Pmi,w.lJ3,w.mPM,Mt,_t,w.f$L,w.hkS,w.oCn,w._fi,w.A8w,w.Uk4,w.QYw,w.Nn4,w.woi,w.WaG,w.yNZ,...e]),widget:Lt(t)}))({undoRedoMenuItemPlugins:u,widgetPlugins:At}),[p,m,y]=await Promise.all([ut.create({pluginRegistry:h,settingRegistry:i}),gt(),Bt.create(s)]),f=new Pe,v={intlTracker:p,jupyterLab:a,jupyterServerProxyEnabled:m,notebookTracker:t,pluginRegistry:h,sessionClients:f,themeTracker:y,widgetStateTrackers:l},j=new tt(v);d.add(j,"left",{rank:700}),o&&o.add(j,"atoti-sidebar"),c.addWidgetExtension("Notebook",new us(v)),c.addWidgetExtension("Notebook",new bt(v)),(()=>{const e=document.createElement("div");e.id=w.pt,e.classList.add(ue),document.body.append(e),ye.default.config({getContainer:fe})})(),(({commandPalette:e,intlTracker:t,jupyterLab:s,notebookTracker:n,sessionClients:o,widgetStateTrackers:i})=>{s.commands.addCommand(nt,{async execute(){const{mdx:e,sessionId:t,widgetCreationCode:a}=it(n),c=Object.assign(Object.assign({},w.TA$.initialState),{serverKey:r}),d=await G({code:a,notebookTracker:n,state:c}),l=o.get(t);if(!l)throw new Error("The execution of the created cell should have created the corresponding SessionClient.");const u=i.get(d.model.metadata);if(!u)throw new Error("The execution of the created cell should have created the corresponding WidgetStateTracker.");const h=await(async e=>e.dataModel?e.dataModel:new Promise((t=>{const s=n=>{e.removeDataModelListener(s),t(n)};e.addDataModelListener(s)})))(l.activePivotClient),{widgetStateDerivedFromMdx:g}=(0,b.jf)({dataModels:{[r]:h},mdx:(0,w.Qc3)(e),widgetPlugin:w.TA$,widgetState:c});u.setWidgetState(g),de({jupyterLab:s})},isVisible:()=>void 0!==it(n),label:()=>(0,x.createIntl)(t.config).formatMessage({id:`commands.${st}.caption`})}),s.contextMenu.addItem({command:nt,selector:ot}),s.contextMenu.addItem({selector:ot,type:"separator"}),e&&e.addItem({category:"Notebook Cell Operations",command:nt})})({commandPalette:n,intlTracker:p,jupyterLab:a,notebookTracker:t,sessionClients:f,widgetStateTrackers:l})},autoStart:!0,id:"atoti",optional:[m.ICommandPalette,p.ILayoutRestorer,f.ISettingRegistry],requires:[y.INotebookTracker,m.IThemeManager]},gs=hs},7147:(e,t,s)=>{var n={"./en-US":[80761,761],"./en-US.js":[80761,761],"./en-US.js.map":[57918,7918]};function o(e){if(!s.o(n,e))return Promise.resolve().then((()=>{var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}));var t=n[e],o=t[0];return s.e(t[1]).then((()=>s(o)))}o.keys=()=>Object.keys(n),o.id=7147,e.exports=o}}]);