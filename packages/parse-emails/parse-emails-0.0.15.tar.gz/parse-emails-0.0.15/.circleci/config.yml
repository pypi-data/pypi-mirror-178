### =============================================================
### This configuration file is used by CircleCI build server
### https://circleci.com/docs/config-sample
### =============================================================
version: 2.1
references:
    tag_filter: &tag_filter
      filters:
        tags:
          only: /^v\d+\.\d+\.\d+$/

    reqs_tox: &reqs_tox
      requires:
        - prepare-tox3-7

    create_requirement_files: &create_requirement_files
      run:
        name: Create requirement files
        command: |
          pip install pipfile-requirements
          pipfile2req > requirements.txt
          pipfile2req -d > requirements-dev.txt

    restore_tox_37_cache: &restore_tox_37_cache
      restore_cache:
        key: tox-37-cache-{{ checksum "Pipfile" }}-{{ checksum "Pipfile.lock" }}

    save_tox_37_cache: &save_tox_37_cache
      save_cache:
        key: tox-37-cache-{{ checksum "Pipfile" }}-{{ checksum "Pipfile.lock" }}
        paths:
          - .tox/py37

jobs:
  tox3-7-unit-tests:
      # docker image circleci/python:3.8.3-buster-node also contains python 3.7
      docker:
        - image: circleci/python:3.8.3-buster-node
      steps:
        - checkout
        - *create_requirement_files
        - *restore_tox_37_cache
        - run:
            name: Setup Tox
            command: |
              pip install tox
        - run:
            name: Tox build
            no_output_timeout: 15m
            command: |
              tox -e py37 -v
        - *save_tox_37_cache

  tox3-8-unit-tests:
      docker:
        - image: circleci/python:3.8.3-buster-node
      steps:
        - checkout
        - *create_requirement_files
        - restore_cache:
            key: tox-38-cache-{{ checksum "Pipfile" }}-{{ checksum "Pipfile.lock" }}
        - run:
            name: Setup Tox
            command: |
              pip install tox
        - run:
            name: Tox build
            no_output_timeout: 15m
            command: |
              tox -e py38 -v -- --cov=parse_emails --cov-report=html
        - store_artifacts:
            path: coverage_html_report
        - run:
            name: Coveralls upload
            command: |
              if [ -n "$COVERALLS_REPO_TOKEN" ]; then
                pip install coveralls
                coveralls
              else
                echo "Skipping coveralls"
              fi

  prepare-tox3-7:
    docker:
      - image: circleci/python:3.8.3-buster-node
    steps:
      - checkout
      - *create_requirement_files
      - *restore_tox_37_cache
      - run:
          name: Setup Tox
          command: |
            pip install tox
      - run:
          name: Tox build
          command: |
            tox -e py37 --notest
      - *save_tox_37_cache
      - persist_to_workspace:
          root: ~/project
          paths:
            - .tox
  precommit-checks:
      docker:
        - image: circleci/python:3.8.3-buster-node
      steps:
        - checkout
        - attach_workspace:
            at: ~/project
        - run:
            name: Pre-commit
            command: |
              . .tox/py37/bin/activate
              pre-commit --version
              pre-commit run -a
              deactivate
  deploy:
      docker:
        - image: circleci/python:3.8.3-buster
      steps:
        - checkout
        - run:
            name: Deploy
            when: always
            command: |
              ./deploy.sh

  run tests:
      docker:
        - image: circleci/python:3.8.3-buster
      steps:
        - run:
            name: run linting and metrics
            when: always
            command: |
              flake8 ./
workflows:
  version: 2.1
  build_and_release:
    jobs:
      - tox3-7-unit-tests:
          <<: *tag_filter
      - tox3-8-unit-tests:
          <<: *tag_filter
      - prepare-tox3-7:
          <<: *tag_filter
      - precommit-checks:
          <<: *tag_filter
          <<: *reqs_tox
      - deploy:
          <<: *tag_filter
          requires:
            - tox3-7-unit-tests
            - tox3-8-unit-tests
