image: python:latest

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYPI_INDEX: "https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/api/v4/groups/${CI_PROJECT_NAMESPACE}/-/packages/pypi/simple"
cache:
  paths:
    - .cache/pip

before_script:
  - python --version  # For debugging
  - python -m pip install --upgrade pip
  - pip config set global.index-url "${PYPI_INDEX}"
  - pip install -r dev-requirements.txt
  - pip install -r ci-requirements.txt

dist:
  only:
    - main
  variables:
    TWINE_PASSWORD: '${CI_JOB_TOKEN}'
    TWINE_USERNAME: 'gitlab-ci-token'
    TWINE_REPOSITORY_URL: 'https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/pypi'
  script:
    # Need to fetch tags
    - git fetch --prune --unshallow
    - git fetch --depth=1 origin +refs/tags/*:refs/tags/*
    - doit dist
    - python -m twine check --strict dist/*
    - python -m twine upload --verbose dist/*

dist-test:
  except:
    - main
  script:
    # Need to fetch tags
    - git fetch --prune --unshallow
    - git fetch --depth=1 origin +refs/tags/*:refs/tags/*
    - doit dist
    - python -m twine check --strict dist/*

install:
  script:
    - doit install

test:
  script:
    - doit unittest
    - cat test/cover_report.log # Get coverage

pages:
  only:
    - main
  script:
    - doit docs
    - mv docs/html/ public/
  artifacts:
    paths:
    - public

